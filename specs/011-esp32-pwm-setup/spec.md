# Feature Specification: ESP32 PWM 頻率與解析度設定

**Feature Branch**: `011-esp32-pwm-setup`  
**Created**: 2025-01-21  
**Status**: Draft  
**Input**: 為 ESP32 開發板新增全域 PWM 設定積木，允許使用者自訂頻率（支援高達 75KHz）和解析度（8-16 bit），用於馬達晶片控制等高頻應用場景

## User Scenarios & Testing _(mandatory)_

**術語說明**：本文件使用的「佔空比 (duty cycle)」指 PWM 訊號中高電平持續時間佔整個週期的比例，用於控制裝置的平均功率輸出。

### User Story 1 - 馬達晶片高頻控制 (Priority: P1)

教育者或學生需要使用 ESP32 控制支援高頻 PWM 的馬達驅動晶片（如 TB6612、DRV8833、AT8833CR 等），這些晶片需要至少 20-75KHz 的 PWM 頻率才能正常運作並避免馬達產生高頻噪音。使用者希望透過視覺化積木介面設定 PWM 參數，而不需要撰寫複雜的 C++ 程式碼。

**註**：AT8833CR 為 DRV8833 的功能相容替代品，具有相同的 PWM 頻率需求（20-75KHz），可用於實體硬體測試。

**Why this priority**: 這是此功能的核心價值。沒有此功能，使用者無法在 Blockly 介面中使用需要高頻 PWM 的硬體，必須手動撰寫程式碼。

**Independent Test**: 可透過拖曳 ESP32 PWM 設定積木並設定 75000Hz / 8bit，然後使用類比輸出積木，檢查生成的 Arduino 程式碼是否正確設定 `ledcSetup(channel, 75000, 8)`，並在實際硬體上驗證馬達驅動晶片正常運作。

**Acceptance Scenarios**:

1. **Given** 使用者選擇 ESP32 開發板，**When** 拖曳「設定 ESP32 PWM」積木並設定頻率為 75000Hz、解析度為 8bit，**Then** 後續的所有類比輸出積木生成的程式碼使用 75000Hz 和 8bit 解析度
2. **Given** 使用者設定 PWM 為 75000Hz / 8bit，**When** 使用類比輸出積木寫入數值 128 到 GPIO25，**Then** 生成的程式碼包含 `ledcSetup(channel, 75000, 8)` 和 `ledcWrite(channel, 128)`，輸出值被限制在 0-255 範圍內
3. **Given** 使用者上傳程式到 ESP32 實體硬體，**When** 執行包含 75KHz PWM 輸出的程式，**Then** 連接的馬達驅動晶片正常運作，馬達運轉平順無異常噪音

---

### User Story 2 - 自動相容性驗證與調整 (Priority: P2)

使用者可能不了解 ESP32 硬體限制（頻率 × 2^解析度 ≤ 80,000,000），意外設定不相容的參數組合（如 75000Hz @ 12bit）。系統應自動驗證並調整設定，防止生成無法運作的程式碼，同時透過註解說明調整原因。

**Why this priority**: 防止使用者遇到「程式碼能編譯但硬體不工作」的困惑情況。這對教育場景特別重要，可減少除錯時間並增進學習體驗。

**Independent Test**: 可透過設定不相容參數（75000Hz @ 12bit）並檢查生成的程式碼是否自動調整為相容配置（如 75000Hz @ 8bit）且包含警告註解，然後驗證程式上傳後硬體正常運作。

**Acceptance Scenarios**:

1. **Given** 使用者設定 75000Hz @ 12bit（超出限制：75000 × 4096 = 307,200,000 > 80,000,000），**When** 生成 Arduino 程式碼，**Then** 系統自動將解析度調整為 8bit，並在程式碼中加入註解說明「⚠️ 警告：原始設定 75000Hz @ 12bit 超出限制，已自動調整為 75000Hz @ 8bit」
2. **Given** 使用者設定相容的參數（5000Hz @ 12bit），**When** 生成程式碼，**Then** 系統不做任何調整，生成的程式碼包含註解說明「驗證: 5000 × 4096 = 20,480,000 < 80,000,000 ✓」
3. **Given** 系統自動調整後的配置，**When** 程式上傳到 ESP32，**Then** 硬體正常初始化 PWM，不會出現 `ESP_FAIL` 或靜默失敗

---

### User Story 3 - 預設值向後相容 (Priority: P3)

現有使用 ESP32 的專案沒有使用 PWM 設定積木，應該繼續以預設值（75000Hz / 8bit）正常運作。新功能不應破壞已存在的工作空間檔案。

**Why this priority**: 確保平滑升級體驗，不讓現有使用者的專案因版本更新而失效。雖然重要，但優先級低於核心功能本身。

**Independent Test**: 開啟一個在舊版本建立的 ESP32 專案（包含類比輸出積木但沒有 PWM 設定積木），驗證載入後能正常生成程式碼，且生成的程式碼使用預設值 75000Hz / 8bit。

**Acceptance Scenarios**:

1. **Given** 舊專案僅包含類比輸出積木，沒有 PWM 設定積木，**When** 在新版本中開啟並生成程式碼，**Then** 生成的程式碼使用預設值 `ledcSetup(channel, 75000, 8)`
2. **Given** 使用者在新專案中沒有拖曳 PWM 設定積木，**When** 直接使用類比輸出積木，**Then** 系統自動使用預設值，不會出現錯誤或警告
3. **Given** 使用者切換開發板從 Arduino Uno 到 ESP32，**When** 生成程式碼，**Then** ESP32 相關的類比輸出使用預設 PWM 設定，Arduino Uno 的 analogWrite 不受影響

---

### User Story 4 - 伺服馬達與 PWM 共存 (Priority: P3)

使用者希望在同一專案中同時使用伺服馬達（SG90/MG90，固定 50Hz）和高頻 PWM 控制馬達驅動晶片（75KHz），兩者應使用不同腳位且互不干擾。

**Why this priority**: 這是進階應用場景，確保功能彈性。雖非核心需求，但對機器人專案很重要。

**Independent Test**: 建立同時包含伺服馬達設定積木（GPIO18）和 ESP32 PWM 設定積木（75KHz）+ 類比輸出積木（GPIO25）的專案，驗證生成的程式碼正確使用兩種獨立的 PWM 系統（ESP32Servo 和 LEDC），並在實體硬體上確認伺服馬達和馬達驅動晶片同時正常運作。

**Acceptance Scenarios**:

1. **Given** 專案包含伺服馬達積木（GPIO18）和 ESP32 PWM 設定（75KHz）+ 類比輸出（GPIO25），**When** 生成程式碼，**Then** 程式碼同時包含 `servo.setPeriodHertz(50)` 和 `ledcSetup(channel, 75000, 8)`，兩者使用不同的硬體資源
2. **Given** 程式上傳到 ESP32，**When** 同時執行伺服馬達控制和高頻 PWM 輸出，**Then** 兩個裝置互不干擾，伺服馬達精確定位且馬達驅動晶片正常運作
3. **Given** 使用者誤將伺服馬達和類比輸出連接到同一腳位，**When** 執行程式，**Then** 文件中有明確警告說明不可共用腳位（此為文件需求，非程式驗證）

---

### Edge Cases

-   **非 ESP32 開發板選擇時**：PWM 設定積木在 toolbox 中完全隱藏，避免使用者誤用
-   **類比輸出值超出解析度範圍**：當設定為 8bit（0-255）時，使用者輸入的類比輸出值應自動透過 `constrain()` 函數限制在有效範圍內
-   **多次設定 PWM 積木**：如果使用者在同一專案中拖曳多個 PWM 設定積木，以最後一個積木的設定為準（後蓋前）
-   **切換開發板後的行為**：當使用者從 ESP32 切換到 Arduino Uno 後再切回 ESP32，PWM 設定應保持不變（透過積木的存在自動重建全域變數，不寫入 main.json）

## Clarifications

### Session 2025-01-21

-   Q: 程式碼生成的效能目標為何？ → A: 程式碼生成應在 500ms 內完成（與現有積木一致）
-   Q: PWM 設定是否應持久化到 main.json 工作區檔案？ → A: 僅在記憶體中保存，不寫入 main.json（透過積木存在自動重建）

## Requirements _(mandatory)_

### Functional Requirements

-   **FR-001**: 系統必須提供一個視覺化積木，允許使用者設定 ESP32 的 PWM 頻率（範圍 1-80000 Hz）
-   **FR-002**: 系統必須提供一個視覺化積木欄位，允許使用者選擇 PWM 解析度（選項：8, 10, 12, 13, 14, 15, 16 bit）
-   **FR-003**: 系統必須將使用者設定的頻率和解析度儲存為全域配置（記憶體中的 window 變數），供所有後續的類比輸出積木使用。此配置不持久化到 main.json，而是在載入工作區時透過掃描 PWM 設定積木自動重建
-   **FR-004**: 系統必須在生成 Arduino 程式碼時驗證頻率與解析度的組合是否符合 ESP32 限制（頻率 × 2^解析度 ≤ 80,000,000）
-   **FR-005**: 當使用者設定不相容的參數組合時，系統必須自動調整解析度至最低可用值（優先選擇 8 bit），並在生成的程式碼中加入警告註解
-   **FR-006**: 系統必須在使用者未設定 PWM 參數時使用預設值（75000 Hz / 8 bit），確保向後相容性
-   **FR-007**: 系統必須根據使用者選擇的解析度動態計算類比輸出的最大值（2^解析度 - 1），並在程式碼中使用 `constrain()` 函數限制輸出範圍
-   **FR-008**: 系統必須僅在使用者選擇 ESP32 開發板時，在積木工具箱中顯示 ESP32 PWM 設定積木；在其他開發板（Arduino Uno、Nano、Mega 等）時，該積木完全不出現在工具箱中（採用隱藏而非禁用狀態，以簡化介面）
-   **FR-009**: 系統必須在生成的 Arduino 程式碼中加入清晰的註解，說明當前的 PWM 配置和驗證結果
-   **FR-010**: 系統必須確保伺服馬達積木（使用 ESP32Servo 庫和 50Hz）與 PWM 設定積木（使用 LEDC 系統）相互獨立運作，不會互相干擾
-   **FR-011**: 系統必須提供繁體中文和英文的介面文字翻譯，包括積木標籤、欄位名稱、解析度選項和 tooltip 說明
-   **FR-012**: PWM 設定積木必須放置在 Arduino 類別的工具箱中，位於「上拉電阻設定」積木之後

### Key Entities

-   **ESP32 PWM 設定積木（esp32_pwm_setup）**：使用者介面元素，包含頻率數字輸入框（預設 75000）和解析度下拉選單（預設 8 bit），僅在 ESP32 開發板時可見
-   **全域 PWM 配置**：儲存於 `window.esp32PwmFrequency` 和 `window.esp32PwmResolution` 的狀態資料，用於協調所有類比輸出積木的程式碼生成
-   **頻率驗證規則**：ESP32 硬體限制公式（頻率 × 2^解析度 ≤ 80,000,000），用於驗證和自動調整參數
-   **類比輸出積木（arduino_analog_write）**：消費全域 PWM 配置的積木，根據配置生成對應的 `ledcSetup()` 和 `ledcWrite()` 呼叫
-   **解析度選項清單**：8, 10, 12, 13, 14, 15, 16 bit，每個選項對應的輸出範圍分別為 0-255, 0-1023, 0-4095, 0-8191, 0-16383, 0-32767, 0-65535

## Success Criteria _(mandatory)_

### Measurable Outcomes

-   **SC-001**: 使用者能在 5 分鐘內完成 ESP32 PWM 設定積木的拖曳和參數配置，無需查閱技術文件
-   **SC-002**: 生成的 Arduino 程式碼能在 ESP32 實體硬體上正確初始化 LEDC PWM，支援 1-80000 Hz 的頻率範圍
-   **SC-003**: 當使用者設定不相容參數時，100% 的情況下系統能自動調整為相容配置，且程式能在硬體上正常運作
-   **SC-004**: 使用馬達驅動晶片（需 20-75KHz PWM）的專案，馬達運轉時無高頻噪音（可透過示波器驗證 PWM 頻率正確）
-   **SC-005**: 現有的 ESP32 專案在升級後無需修改即可正常運作（使用預設值 75000Hz / 8bit）
-   **SC-006**: 伺服馬達和高頻 PWM 可在同一專案中同時使用，硬體測試無互相干擾現象
-   **SC-007**: 90% 的使用者能透過積木的 tooltip 說明理解頻率與解析度的限制關係，無需額外技術支援（測量方法：教育場景觀察或使用者問卷調查，監測技術支援請求數量是否低於 10% 使用者基數）
-   **SC-008**: 生成的程式碼註解清晰標示 PWM 配置和驗證結果，開發者能在 30 秒內理解當前設定
-   **SC-009**: 程式碼生成作業在 500ms 內完成（測試條件：包含 10 個類比輸出積木的專案，在 Intel i5 或同等級處理器上執行），保持與現有積木一致的即時回饋體驗
-   **SC-010**: 測試覆蓋率達到 100% 核心邏輯（定義：驗證函數 validateAndAdjustPwmConfig、程式碼生成器 arduino_analog_write 的 ESP32 分支、全域配置重建邏輯 rebuildPwmConfig），WebView 積木互動功能使用手動測試

### Assumptions

-   使用者已安裝 PlatformIO 和對應的 ESP32 開發板支援
-   使用者了解基本的 PWM 概念（頻率、佔空比）
-   使用者的 ESP32 硬體為標準 ESP32（非 S2/S3/C3 變體），時鐘源為 APB_CLK 80MHz
-   使用者不會在同一腳位同時使用伺服馬達和類比輸出積木
-   馬達驅動晶片的規格需求已由使用者或教學材料事先確認（如需 20-75KHz）

### Out of Scope

-   本功能不支援 ESP32-S2/S3/C3 的特殊 PWM 配置差異（假設使用標準 ESP32）
-   不提供每腳位獨立設定不同頻率的功能（採用全域設定）
-   不自動偵測硬體連接的裝置類型並建議 PWM 參數
-   不驗證使用者連接的實際硬體是否支援設定的頻率（由硬體規格書決定）
-   不處理使用 WiFi 時 ADC2 通道的限制問題（超出 PWM 設定範圍）
-   不提供視覺化的頻率-解析度相容性檢查圖表（僅透過文字 tooltip 說明）
-   除繁體中文和英文外的語言翻譯不在初始實作範圍（未來版本補充，不在本次任務範圍）

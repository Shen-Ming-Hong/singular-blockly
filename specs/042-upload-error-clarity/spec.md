# Feature Specification: 上傳錯誤分類與明確提示

**Feature Branch**: `042-upload-error-clarity`  
**Created**: 2026-02-10  
**Status**: Draft  
**Input**: User description: "在上傳程式的按鈕當上傳失敗的時候希望可以更清楚提示是沒有偵測到硬體還是編譯失敗還是有偵測到硬體但是上傳失敗"

## Clarifications

### Session 2026-02-10

- Q: 當使用者選擇「僅編譯」模式時，硬體偵測步驟應如何處理？ → A: 僅編譯模式完全跳過硬體偵測，直接進入編譯流程

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 未連接硬體時上傳提示無硬體 (Priority: P1)

使用者點擊上傳按鈕時，若電腦上沒有連接任何 Arduino 開發板，系統應在進入編譯之前就偵測到此情況，並立即顯示明確的「未偵測到硬體裝置」錯誤訊息，而非等待編譯完成後才報出模糊的「上傳失敗」。

**Why this priority**: 這是最常見的上傳失敗情境。目前使用者必須等待整個編譯流程完成後才發現根本沒接硬體，浪費時間且錯誤訊息不明確，常令初學者困惑。

**Independent Test**: 不連接任何 Arduino 板子，直接點擊上傳按鈕。應在 2 秒內看到明確的「未偵測到硬體裝置」提示，且不應進入編譯階段。

**Acceptance Scenarios**:

1. **Given** 使用者已選擇 Arduino 類開發板（如 ESP32、UNO），且電腦未連接任何開發板, **When** 使用者點擊上傳按鈕, **Then** 系統顯示「未偵測到硬體裝置，請確認開發板已連接」的本地化錯誤訊息，按鈕回到可用狀態
2. **Given** 使用者已選擇 Arduino 類開發板，且電腦未連接任何開發板, **When** 使用者點擊上傳按鈕, **Then** 系統不會進入編譯階段，進度提示僅到「偵測裝置」階段即停止
3. **Given** 使用者使用非英文語系（如繁體中文）, **When** 硬體未連接而上傳失敗時, **Then** 錯誤訊息以該語系顯示

---

### User Story 2 - 編譯失敗時顯示編譯錯誤 (Priority: P1)

使用者的積木程式產生了有語法或型別錯誤的程式碼。上傳時編譯失敗，系統應明確告知是「編譯失敗」並附上錯誤細節，讓使用者知道需要檢查程式碼，而非只顯示籠統的「上傳失敗」。

**Why this priority**: 編譯失敗是第二常見的上傳失敗原因，且使用者需要知道問題出在程式碼上才能採取正確的修正行動。

**Independent Test**: 連接開發板但使用包含錯誤的積木組合（如缺少必要的設定積木），點擊上傳。應看到「編譯失敗」並附帶編譯器的錯誤摘要。

**Acceptance Scenarios**:

1. **Given** 使用者已連接開發板，且積木程式碼存在語法錯誤, **When** 使用者點擊上傳按鈕, **Then** 系統顯示「編譯失敗」的本地化訊息，並在括號中附帶具體的編譯錯誤摘要
2. **Given** 程式碼有多個編譯錯誤, **When** 上傳失敗, **Then** 系統擷取第一個主要錯誤訊息顯示，長度不超過 200 字元

---

### User Story 3 - 上傳過程中硬體斷線或連接埠問題 (Priority: P2)

使用者的開發板已連接且程式碼能正確編譯，但上傳過程中出現問題（如 USB 線鬆動、連接埠被其他程式佔用）。系統應明確區分此情況為「硬體連接問題」而非「編譯問題」或「無硬體」。

**Why this priority**: 發生頻率低於前兩者，但仍需與其他兩種錯誤做清楚區分，讓使用者能採取正確的修正措施（檢查 USB 連線或關閉佔用連接埠的程式）。

**Independent Test**: 連接開發板並開始上傳，在上傳進行中拔掉 USB 線，或先用另一個程式佔用 COM 埠再嘗試上傳。應看到「裝置連接問題」相關的明確訊息。

**Acceptance Scenarios**:

1. **Given** 開發板已連接，程式碼編譯成功, **When** 上傳過程中裝置斷線, **Then** 系統顯示「裝置已斷開連接」的本地化訊息，並附帶技術細節
2. **Given** 開發板的連接埠被其他程式佔用, **When** 使用者點擊上傳, **Then** 系統顯示「裝置連接埠被佔用」的本地化訊息
3. **Given** 上傳過程中發生通訊逾時, **When** 上傳失敗, **Then** 系統顯示「連接逾時」相關的明確訊息，而非籠統的「上傳失敗」

---

### User Story 4 - CyberBrick (MicroPython) 上傳錯誤不受影響 (Priority: P2)

CyberBrick 開發板使用 MicroPython 上傳流程，目前已有獨立的裝置偵測階段和明確的錯誤分類。此功能改進不應影響 CyberBrick 的現有上傳行為。

**Why this priority**: 確保改動不會引入回歸問題，對已正常運作的功能至關重要。

**Independent Test**: 使用 CyberBrick 板子進行上傳（無裝置、有裝置），確認所有現有錯誤訊息不變。

**Acceptance Scenarios**:

1. **Given** 使用者選擇 CyberBrick 板子，且裝置未連接, **When** 點擊上傳, **Then** 仍顯示「找不到 CyberBrick 裝置，請確認已連接」（與現有行為一致）
2. **Given** 使用者選擇 CyberBrick 板子, **When** 上傳成功或失敗, **Then** 所有訊息與目前版本完全相同

---

### User Story 5 - 錯誤訊息包含技術細節輔助除錯 (Priority: P3)

進階使用者或教師在排查問題時，需要看到來自底層工具的原始錯誤訊息。系統應在本地化的錯誤描述後方附帶技術細節（如 PlatformIO 的原始錯誤輸出），方便進階除錯。

**Why this priority**: 對初學者最重要的是本地化的錯誤分類訊息；技術細節是附加價值，主要服務進階使用者。

**Independent Test**: 觸發任一種上傳錯誤，確認 toast 訊息中包含本地化描述加上原始技術細節。

**Acceptance Scenarios**:

1. **Given** Arduino 上傳因連接問題失敗, **When** 系統顯示錯誤時, **Then** 訊息格式為「上傳失敗：{本地化錯誤描述} ({PlatformIO 原始錯誤摘要})」
2. **Given** 底層工具未回傳可解析的技術細節, **When** 系統顯示錯誤時, **Then** 僅顯示本地化錯誤描述，不加空括號

---

### Edge Cases

- 系統偵測到多個 Arduino 裝置：應使用第一個偵測到的裝置，行為與現有邏輯一致
- 藍牙虛擬連接埠被誤認為 Arduino 裝置：偵測邏輯應過濾藍牙裝置（這已在現有的 `detectDevices()` 中處理）
- PlatformIO CLI 存在但 `pio device list` 指令失敗：應 fallback 為繼續上傳流程（使用 `auto` 偵測），不因偵測失敗而阻斷整個流程
- 使用者在偵測裝置過程中拔除硬體：系統仍可進入編譯階段，但上傳時會因找不到裝置而顯示上傳錯誤（兜底保護）
- 錯誤訊息中的技術細節過長：應截斷至 200 字元以避免 toast 訊息溢出

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系統在 Arduino **上傳**（非「僅編譯」）前 MUST 主動偵測是否有硬體裝置連接，若無裝置則立即回報錯誤，不進入編譯階段。「僅編譯」模式 MUST 跳過硬體偵測，直接進入編譯流程
- **FR-002**: 系統 MUST 將上傳失敗區分為三種明確的錯誤類別：(1) 未偵測到硬體、(2) 編譯失敗、(3) 有硬體但上傳過程失敗
- **FR-003**: 每種錯誤類別 MUST 有對應的本地化錯誤訊息，支援專案既有的全部 15 種語言
- **FR-004**: Arduino 上傳失敗的錯誤訊息 MUST 包含本地化的錯誤描述，並在有可用的技術細節時附帶原始錯誤摘要
- **FR-005**: 系統 MUST 在硬體偵測階段顯示對應的進度提示（如「偵測裝置中...」）
- **FR-006**: 上傳過程中的連接埠錯誤（佔用、斷線、逾時）MUST 各自對應明確的錯誤訊息
- **FR-007**: CyberBrick (MicroPython) 的上傳流程和錯誤訊息 MUST NOT 受此功能影響
- **FR-008**: 當硬體偵測功能本身失敗時（如 PlatformIO 指令異常），系統 MUST fallback 為繼續上傳流程，不阻斷使用者操作
- **FR-009**: 技術細節摘要 MUST 截斷至合理長度（不超過 200 字元），以確保 UI 訊息可讀性

### Key Entities

- **錯誤類別 (Error Category)**: 「無硬體」、「編譯失敗」、「上傳失敗」三種類別，對應不同的上傳失敗階段
- **上傳階段 (Upload Stage)**: 上傳流程中的各階段，包含偵測、編譯、上傳，每個階段有自己的進度提示和對應的錯誤處理
- **本地化錯誤訊息 (Localized Error Message)**: 根據使用者語系和錯誤類別組合而成的最終顯示訊息

## Assumptions

- PlatformIO CLI 的 `device list` 指令可在 2 秒內回傳結果，不會對上傳體驗造成明顯延遲
- 硬體偵測的結果在偵測到上傳開始的短暫時間內不會改變（使用者不太會在此瞬間拔裝置）
- 現有的 15 種語言翻譯中，新增的 key 可先以英文作為 placeholder，後續透過本地化流程完成翻譯

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 使用者在未連接硬體時點擊上傳，能在 3 秒內看到「未偵測到硬體」的明確提示，無需等待編譯
- **SC-002**: 上傳失敗時，95% 以上的情境使用者能從錯誤訊息直接判斷出失敗原因屬於「無硬體」、「編譯問題」或「連接問題」中的哪一種
- **SC-003**: 所有上傳錯誤訊息皆有本地化版本，`npm run validate:i18n` 通過，15 種語言無缺漏
- **SC-004**: CyberBrick 上傳流程通過既有測試，行為與改動前完全一致
- **SC-005**: 進階使用者能從錯誤訊息中獲得足夠的技術細節（如 PlatformIO 原始錯誤）來自行排查問題
